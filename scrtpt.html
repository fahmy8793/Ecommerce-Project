<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="products"></div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        limit,
        getDocs,
        startAfter,
        where,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAEpHidRTkCegpQmOzHy6hV7iApvAJIFoM",
        authDomain: "test-de06d.firebaseapp.com",
        projectId: "test-de06d",
        storageBucket: "test-de06d.firebasestorage.app",
        messagingSenderId: "308036633924",
        appId: "1:308036633924:web:1894faeee93a0815b14311",
        measurementId: "G-XKSNCZ34EL",
      };

      const app = initializeApp(firebaseConfig);
      const database = getFirestore(app);

      //بجيب ال داتا من من قاعده بيانات ال firebase
      async function getProducts(lastVisible = null) {
        try {
          const productsRef = collection(database, "products"); //اسم المنتجات في ال firestore
          let q; // الاستعلام
          if (lastVisible) {
            q = query(
              productsRef,

              startAfter(lastVisible),
              limit(9)
            );
          } else {
            q = query(productsRef, limit(9)); //limit 9 بحد اقصي ٩ منتجات
          }
          const querySnapshot = await getDocs(q);

          const productsArray = []; //بنخزن المنتجات في ال array
          querySnapshot.forEach((doc) => {
            productsArray.push({ ID: doc.id, ...doc.data() });
          });

          return {
            productsArray,
            lastVisible: querySnapshot.docs[querySnapshot.docs.length - 1],
          };
        } catch (error) {
          console.error("Error fetching products: ", error);
          return { productsArray: [], lastVisible: null };
        }
      }

      getProducts() // عرض المنتجات
        .then((products) => {
          console.log(products);
          const productsDiv = document.getElementById("products");
          if (!productsDiv) {
            console.error("Products div not found!");
            return;
          }
          products.productsArray.forEach((product) => {
            const card = document.createElement("div");
            card.className = "card"; // اضافه card from bootsrap

            if (product.imageUrl) {
              const img = document.createElement("img");
              img.src = product.imageUrl; // adding image
              img.className = "card-img-top";
              img.onerror = () => {
                console.error(
                  `Failed to load image for ${product.name}: ${product.imageUrl}`
                );
                img.remove(); //  لو في error يحذق  الصوره
              };
              card.appendChild(img);
            }
            // باقي الكارت السعر والاسم والوصف
            const cardBody = document.createElement("div");
            cardBody.className = "card-body";

            const title = document.createElement("h5");
            title.className = "card-title";
            title.textContent = product.name;
            cardBody.appendChild(title);

            const text = document.createElement("p");
            text.className = "card-text";
            text.textContent = `  Description: ${product.Description}\n`;
            cardBody.appendChild(text);

            const price = document.createElement("a");
            price.href = "#";
            price.className = " btn btn-primary";
            price.textContent = `${product.price} EGP`;
            cardBody.appendChild(price);

            card.appendChild(cardBody);
            productsDiv.appendChild(card);
          });
        })
        .catch((error) => {
          console.error("Error displaying products: ", error);
        });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
